<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BreatheEasy - AI Health Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }

        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.95);
            border-bottom: 1px solid rgba(75, 85, 99, 0.5);
        }

        .chat-bubble {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Markdown Styles */
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose strong {
            font-weight: 700;
            color: inherit;
        }

        .prose p {
            margin-bottom: 0.8em;
        }
    </style>
</head>

<body
    class="font-inter bg-gray-50 text-gray-900 antialiased h-screen flex flex-col dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- Header -->
    <header class="glass-effect fixed top-0 left-0 right-0 z-50 h-16">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between items-center h-full">
                <a href="index.html" class="flex items-center group">
                    <div
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-medical-600 to-indigo-600 dark:from-medical-400 dark:to-indigo-400">
                        <i
                            class="fas fa-lungs mr-2 text-medical-600 dark:text-medical-400 group-hover:scale-110 transition-transform"></i>BreatheEasy
                    </div>
                </a>

                <div class="flex items-center space-x-4">
                    <a href="index.html"
                        class="text-gray-600 hover:text-medical-600 dark:text-gray-300 dark:hover:text-medical-400 font-medium transition-colors">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <button onclick="toggleTheme()"
                        class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon text-gray-600 dark:text-gray-300" id="theme-icon"></i>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Chat Container -->
    <main class="flex-1 pt-16 flex flex-col max-w-5xl mx-auto w-full px-4 sm:px-6 lg:px-8 pb-4">

        <!-- API Key Input Modal (Overlay) -->
        <div id="api-key-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
            <div
                class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 border border-medical-100 dark:border-gray-700">
                <div class="text-center mb-6">
                    <div
                        class="w-16 h-16 bg-medical-100 dark:bg-medical-900 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-key text-medical-600 dark:text-medical-400 text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Setup Assistant</h2>
                    <p class="text-gray-600 dark:text-gray-300">Please enter your Google Gemini API Key to enable the AI
                        health assistant.</p>
                </div>
                <input type="password" id="modal-api-key" placeholder="Enter API Key (starts with AIza...)"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-medical-500 focus:border-transparent dark:bg-gray-700 dark:text-white mb-4 outline-none transition-all">
                <button onclick="saveApiKey()"
                    class="w-full bg-gradient-to-r from-medical-600 to-indigo-600 hover:from-medical-700 hover:to-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-95 transition-all">
                    Access Assistant
                </button>
                <p class="mt-4 text-center text-sm text-gray-500">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank"
                        class="text-medical-600 hover:underline">Get a free API key here</a>
                </p>
            </div>
        </div>

        <!-- Chat Interface -->
        <div
            class="flex-1 flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 mt-6 overflow-hidden">

            <!-- Toolbar -->
            <div
                class="bg-gray-50 dark:bg-gray-900/50 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Gemini Pro â€¢ Medical
                        Assistant Mode</span>
                </div>
                <button onclick="resetApiKey()"
                    class="text-xs text-gray-500 hover:text-red-500 flex items-center transition-colors"
                    title="Reset API Key">
                    <i class="fas fa-trash-alt mr-1"></i> Reset Key
                </button>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Welcome Message -->
                <div class="chat-bubble flex items-start">
                    <div
                        class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-medical-500 to-indigo-500 flex items-center justify-center text-white shadow-md">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div
                        class="ml-4 bg-gray-100 dark:bg-gray-700/50 rounded-2xl rounded-tl-none p-5 max-w-2xl text-gray-800 dark:text-gray-200 shadow-sm border border-gray-100 dark:border-gray-600">
                        <h3 class="font-bold text-lg mb-2">Hello! ðŸ‘‹</h3>
                        <p class="mb-3">I'm your Lung Cancer Health Assistant. I can help you with:</p>
                        <ul class="list-disc pl-5 space-y-1 mb-3">
                            <li>Understanding different types of lung cancer</li>
                            <li>Recognizing early symptoms and warning signs</li>
                            <li>Prevention strategies and risk factors</li>
                            <li>Explaining the AI detection results</li>
                        </ul>
                        <p
                            class="text-sm text-gray-500 dark:text-gray-400 italic border-t border-gray-200 dark:border-gray-600 pt-2 mt-2">
                            <i class="fas fa-shield-alt mr-1"></i> Disclaimer: I provide information for educational
                            purposes only. Always consult a doctor for diagnosis.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                <div class="relative flex items-end">
                    <textarea id="user-input" rows="1" placeholder="Type your health question here..."
                        class="w-full pl-5 pr-14 py-4 rounded-xl border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-medical-500 focus:border-transparent dark:bg-gray-700 dark:text-white resize-none shadow-inner transition-all text-lg"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    <button id="send-btn" onclick="sendMessage()"
                        class="absolute right-3 bottom-2.5 p-2 bg-medical-600 hover:bg-medical-700 text-white rounded-lg shadow-md transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane text-lg w-6 h-6 flex items-center justify-center"></i>
                    </button>
                </div>
                <div class="text-center mt-3 text-xs text-gray-400">
                    AI can make mistakes. Please verify important medical information.
                </div>
            </div>
        </div>
    </main>

    <script>
        // Theme Logic
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            icon.className = isDark ? 'fas fa-sun text-yellow-400' : 'fas fa-moon text-gray-600';
        }

        // Init Logic
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            }

            checkApiKey();

            // Enter key to send
            document.getElementById('user-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // API Key Management
        function checkApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (!key) {
                document.getElementById('api-key-modal').classList.remove('hidden');
            } else {
                document.getElementById('api-key-modal').classList.add('hidden');
            }
        }

        function saveApiKey() {
            const input = document.getElementById('modal-api-key');
            const key = input.value.trim();
            if (key.length > 10) {
                localStorage.setItem('gemini_api_key', key);
                checkApiKey();
            } else {
                alert("Please enter a valid API key");
            }
        }

        function resetApiKey() {
            if (confirm("Are you sure you want to clear your API Key?")) {
                localStorage.removeItem('gemini_api_key');
                localStorage.removeItem('gemini_model'); // Clear cached model
                location.reload();
            }
        }

        // Dynamic Model Discovery
        async function getBestModel(apiKey) {
            // Check cache
            if (localStorage.getItem('gemini_model')) {
                return localStorage.getItem('gemini_model');
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!response.ok) return 'gemini-1.5-flash'; // Fallback

                const data = await response.json();
                const textModels = data.models.filter(m =>
                    m.supportedGenerationMethods.includes('generateContent') &&
                    m.name.includes('gemini')
                );

                // Prefer flash, then pro, then anything else
                let bestModel = 'gemini-1.5-flash';
                const preferred = textModels.find(m => m.name.includes('flash')) ||
                    textModels.find(m => m.name.includes('pro')) ||
                    textModels[0];

                if (preferred) {
                    bestModel = preferred.name.split('/').pop(); // Get just the name like "gemini-pro"
                }

                localStorage.setItem('gemini_model', bestModel);
                console.log("Selected Model:", bestModel);
                return bestModel;

            } catch (e) {
                console.error("Model discovery failed", e);
                return 'gemini-1.5-flash'; // Fallback
            }
        }

        // Chat Logic
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto'; // Reset height

            appendMessage('user', message);
            showTypingIndicator();

            try {
                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) throw new Error("API Key missing");

                // Get a valid model dynamically
                const modelName = await getBestModel(apiKey);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a helpful, empathetic, and professional health assistant specializing in lung cancer info. 
                            User Question: "${message}"
                            Provide a clear, accurate, and concise answer using Markdown formatting (bolding, lists). 
                            Always maintain a supportive tone. If the question is unrelated to health, polite redirect.`
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    let errorMessage = `API Error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMessage = errorData.error.message;
                        }
                    } catch (e) {
                        // Could not parse JSON error response
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                const botText = data.candidates[0].content.parts[0].text;

                removeTypingIndicator();
                appendMessage('bot', botText);

            } catch (error) {
                removeTypingIndicator();
                appendMessage('bot', `**Error:** ${error.message}. <br><br>Please check your API Key and ensure it has access to Generative Language API.`);
                console.error(error);
            }
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-bubble flex items-start ' + (role === 'user' ? 'justify-end' : '');

            const avatar = role === 'bot'
                ? `<div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-medical-500 to-indigo-500 flex items-center justify-center text-white shadow-md"><i class="fas fa-robot"></i></div>`
                : `<div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300 shadow-md ml-4"><i class="fas fa-user"></i></div>`;

            const bubbleStyle = role === 'bot'
                ? 'bg-gray-100 dark:bg-gray-700/50 text-gray-800 dark:text-gray-200 rounded-tl-none border border-gray-100 dark:border-gray-600 mr-12'
                : 'bg-medical-600 text-white rounded-tr-none ml-12 shadow-lg';

            const content = role === 'bot' ? marked.parse(text) : text.replace(/\n/g, '<br>');

            div.innerHTML = role === 'bot'
                ? `${avatar}<div class="ml-4 ${bubbleStyle} rounded-2xl p-5 max-w-2xl shadow-sm prose dark:prose-invert prose-p:my-1 prose-ul:my-2">${content}</div>`
                : `<div class="${bubbleStyle} rounded-2xl p-4 max-w-2xl text-lg">${content}</div>${avatar}`;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'chat-bubble flex items-start';
            div.innerHTML = `
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-medical-500 to-indigo-500 flex items-center justify-center text-white shadow-md"><i class="fas fa-robot"></i></div>
            <div class="ml-4 bg-gray-100 dark:bg-gray-700/50 rounded-2xl rounded-tl-none p-4 shadow-sm border border-gray-100 dark:border-gray-600">
                <div class="flex space-x-2">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }
    </script>
</body>

</html>